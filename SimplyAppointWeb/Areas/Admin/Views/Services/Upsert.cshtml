@using SimplyAppoint.Models.ViewModels.Services
@model ServiceUpsertVM

@{
    var isEdit = Model != null && Model.Id > 0;
    ViewData["Title"] = isEdit ? "Edit Service" : "Create Service";
    Layout = "_AdminLayout";
}

<style>
    .field-validation-error {
        color: #ffb4b4;
        font-size: .85rem;
        font-weight: 600;
        display: block;
        margin-top: .35rem;
    }

    .validation-summary-errors {
        color: #ffb4b4;
    }

    .card .form-control,
    .card .form-select {
        background-color: rgba(255,255,255,.04);
        border-color: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
    }

    .input-group-text {
        border-color: rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        color: rgba(255,255,255,.75);
    }

    .sa-preview-pill {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        border-radius: 14px;
        padding: .75rem .85rem;
    }

    .sa-muted {
        color: rgba(255,255,255,.65);
    }
</style>

<div class="row mb-2 mb-xl-3 align-items-center">
    <div class="col-auto d-none d-sm-block">
        <h3 class="mb-0"><strong>@(isEdit ? "Edit Service" : "Create Service")</strong></h3>
        <div class="text-muted">
            @(isEdit ? "Update service duration, price and buffers" : "Add a new service with duration and price")
        </div>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Services" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="arrow-left"></i> Back to Services
        </a>

        <button type="submit" form="serviceUpsertForm" class="btn btn-primary">
            <i class="align-middle me-1" data-feather="save"></i> @(isEdit ? "Save changes" : "Create Service")
        </button>
    </div>
</div>

<div class="row">
    <!-- Form -->
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <h5 class="card-title mb-0">Service Details</h5>
            </div>

            <div class="card-body">
                <form id="serviceUpsertForm"
                      method="post"
                      asp-area="Admin"
                      asp-controller="Services"
                      asp-action="Upsert"
                      novalidate>

                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="mb-3"></div>

                    <input asp-for="Id" type="hidden" />

                    <!-- Name -->
                    <div class="mb-3">
                        <label asp-for="Name" class="form-label">Service name</label>
                        <input asp-for="Name" class="form-control" placeholder="e.g. Haircut" maxlength="200" />
                        <span asp-validation-for="Name"></span>
                        <div class="form-text">Shown to customers when booking.</div>
                    </div>

                    <!-- Active -->
                    <div class="mb-3">
                        <label asp-for="IsActive" class="form-label">Status</label>
                        <select asp-for="IsActive" class="form-select">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                        <span asp-validation-for="IsActive"></span>
                        <div class="form-text">Inactive services won’t appear in booking.</div>
                    </div>

                    <hr class="my-4" />

                    <!-- Duration + Price -->
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <label asp-for="DurationMinutes" class="form-label">Duration (minutes)</label>
                            <input asp-for="DurationMinutes"
                                   class="form-control"
                                   type="number"
                                   min="1"
                                   max="1440"
                                   step="1" />
                            <span asp-validation-for="DurationMinutes"></span>
                            <div class="form-text">Used to block time in your calendar.</div>
                        </div>

                        <div class="col-12 col-md-6 mb-3">
                            <label asp-for="Price" class="form-label">Price (€)</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="Price"
                                       class="form-control"
                                       type="number"
                                       step="0.01"
                                       min="0.01"
                                       max="1000000" />
                            </div>
                            <span asp-validation-for="Price"></span>
                            <div class="form-text">Must be at least €0.01 (per model validation).</div>
                        </div>
                    </div>

                    <!-- Buffers -->
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <label asp-for="BufferBefore" class="form-label">Buffer before (minutes)</label>
                            <input asp-for="BufferBefore"
                                   class="form-control"
                                   type="number"
                                   min="0"
                                   max="1440"
                                   step="1" />
                            <span asp-validation-for="BufferBefore"></span>
                            <div class="form-text">Optional setup time before appointment.</div>
                        </div>

                        <div class="col-12 col-md-6 mb-3">
                            <label asp-for="BufferAfter" class="form-label">Buffer after (minutes)</label>
                            <input asp-for="BufferAfter"
                                   class="form-control"
                                   type="number"
                                   min="0"
                                   max="1440"
                                   step="1" />
                            <span asp-validation-for="BufferAfter"></span>
                            <div class="form-text">Optional cleanup time after appointment.</div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="card-footer d-flex justify-content-end gap-2">
                <a asp-area="Admin" asp-controller="Services" asp-action="Index" class="btn btn-light bg-white">
                    Cancel
                </a>
                <button type="submit" form="serviceUpsertForm" class="btn btn-primary">
                    <i class="align-middle me-1" data-feather="save"></i> @(isEdit ? "Save changes" : "Create Service")
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-12 col-lg-4 d-flex">
        <div class="d-flex flex-column w-100">

            <!-- Preview -->
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Preview</h5>
                </div>

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge badge-primary-light">Service</span>
                            <span id="pvActiveBadge" class="badge badge-success-light">Active</span>
                        </div>
                        <i class="align-middle text-muted" data-feather="eye"></i>
                    </div>

                    <h4 class="mt-3 mb-1" id="pvName">@(string.IsNullOrWhiteSpace(Model?.Name) ? "New service" : Model!.Name)</h4>

                    <div class="sa-preview-pill mt-3">
                        <div class="d-flex justify-content-between">
                            <span class="sa-muted">Duration</span>
                            <span class="fw-semibold" id="pvDuration">@(Model?.DurationMinutes > 0 ? $"{Model.DurationMinutes} min" : "—")</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="sa-muted">Price</span>
                            <span class="fw-semibold" id="pvPrice">@(Model?.Price > 0 ? $"€ {Model.Price:0.00}" : "—")</span>
                        </div>

                        <div class="d-flex justify-content-between mt-2">
                            <span class="sa-muted">Total block</span>
                            <span class="fw-semibold" id="pvTotal">—</span>
                        </div>
                    </div>

                    <div class="mt-3 sa-muted small">
                        Total block = Duration + Buffer before + Buffer after
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const nameEl = document.getElementById("Name");
            const activeEl = document.getElementById("IsActive");
            const durEl = document.getElementById("DurationMinutes");
            const priceEl = document.getElementById("Price");
            const bufBeforeEl = document.getElementById("BufferBefore");
            const bufAfterEl = document.getElementById("BufferAfter");

            const pvName = document.getElementById("pvName");
            const pvActiveBadge = document.getElementById("pvActiveBadge");
            const pvDuration = document.getElementById("pvDuration");
            const pvPrice = document.getElementById("pvPrice");
            const pvTotal = document.getElementById("pvTotal");

            function n(v) {
                const x = parseFloat(v);
                return Number.isFinite(x) ? x : 0;
            }

            function refresh() {
                const nm = (nameEl?.value || "").trim();
                pvName.textContent = nm || "New service";

                const isActive = (activeEl?.value || "true") === "true";
                pvActiveBadge.textContent = isActive ? "Active" : "Inactive";
                pvActiveBadge.className = "badge " + (isActive ? "badge-success-light" : "badge-danger-light");

                const dur = n(durEl?.value);
                pvDuration.textContent = dur > 0 ? (dur + " min") : "—";

                const price = n(priceEl?.value);
                pvPrice.textContent = price > 0 ? ("€ " + price.toFixed(2)) : "—";

                const bb = n(bufBeforeEl?.value);
                const ba = n(bufAfterEl?.value);
                const total = dur + bb + ba;

                pvTotal.textContent = total > 0 ? (total + " min") : "—";
            }

            ["input", "change"].forEach(evt => {
                nameEl?.addEventListener(evt, refresh);
                activeEl?.addEventListener(evt, refresh);
                durEl?.addEventListener(evt, refresh);
                priceEl?.addEventListener(evt, refresh);
                bufBeforeEl?.addEventListener(evt, refresh);
                bufAfterEl?.addEventListener(evt, refresh);
            });

            refresh();
            if (window.feather) window.feather.replace();
        })();
    </script>
}