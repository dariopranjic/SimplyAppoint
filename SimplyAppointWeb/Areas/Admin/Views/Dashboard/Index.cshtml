@using SimplyAppoint.Models.ViewModels
@using SimplyAppoint.Models.Enums
@model DashboardVM

@{
    ViewData["Title"] = "Dashboard";
    Layout = "_AdminLayout";
}

<div class="row mb-2 mb-xl-3">
    <div class="col-auto d-none d-sm-block">
        <h3><strong>Dashboard</strong></h3>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white me-2">Open Calendar</a>
        <a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-primary">View Appointments</a>
    </div>
</div>

@* --- STAT CARDS --- *@
<div class="row">
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Today’s Appointments</h5></div>
                    <div class="col-auto"><div class="stat text-primary"><i data-feather="clock"></i></div></div>
                </div>
                <h1 class="mt-1 mb-3">@Model.TodayAppointmentsCount</h1>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Upcoming (7 days)</h5></div>
                    <div class="col-auto"><div class="stat text-primary"><i data-feather="calendar"></i></div></div>
                </div>
                <h1 class="mt-1 mb-3">@Model.UpcomingSevenDaysCount</h1>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Cancellations (7 days)</h5></div>
                    <div class="col-auto"><div class="stat text-primary"><i data-feather="x-circle"></i></div></div>
                </div>
                <h1 class="mt-1 mb-3">@Model.CancellationsSevenDays</h1>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">New Customers (30 days)</h5></div>
                    <div class="col-auto"><div class="stat text-primary"><i data-feather="user-plus"></i></div></div>
                </div>
                <h1 class="mt-1 mb-3">@Model.NewCustomersThirtyDays</h1>
            </div>
        </div>
    </div>
</div>

<div class="row">
    @* --- CHART --- *@
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill w-100">
            <div class="card-header">
                <div class="float-end">
                    <select id="chartFilter" class="form-select form-select-sm bg-light border-0">
                        <option value="7" selected="selected">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                    </select>
                </div>
                <h5 class="card-title mb-0">Bookings Trend</h5>
            </div>
            <div class="card-body pt-2 pb-3">
                <div class="chart chart-md"><canvas id="chart-bookings-trend"></canvas></div>
            </div>
        </div>
    </div>

    @* --- QUICK ACTIONS --- *@
    <div class="col-12 col-lg-4 d-flex">
        <div class="card flex-fill w-100">
            <div class="card-header"><h5 class="card-title mb-0">Quick Actions</h5></div>
            <div class="card-body pt-2">
                <div class="row g-2">
                    <div class="col-6"><a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-outline-primary w-100 py-2"><i class="me-2" data-feather="calendar"></i> Appointments</a></div>
                    <div class="col-6"><a asp-area="Admin" asp-controller="Customers" asp-action="Index" class="btn btn-outline-primary w-100 py-2"><i class="me-2" data-feather="users"></i> Customers</a></div>
                    <div class="col-6"><a asp-area="Admin" asp-controller="Services" asp-action="Index" class="btn btn-outline-primary w-100 py-2"><i class="me-2" data-feather="briefcase"></i> Services</a></div>
                    <div class="col-6"><a asp-area="Admin" asp-controller="Settings" asp-action="Index" class="btn btn-outline-primary w-100 py-2"><i class="me-2" data-feather="settings"></i> Settings</a></div>
                </div>
                <hr class="my-3"><div class="d-grid"><a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-primary">Open Today</a></div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    @* --- NEXT APPOINTMENTS --- *@
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header"><h5 class="card-title mb-0">Next Appointments</h5></div>
            <table class="table table-hover my-0">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Customer</th>
                        <th class="d-none d-xl-table-cell">Service</th>
                        <th class="d-none d-xl-table-cell">Status</th>
                        <th class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var appt in Model.NextAppointments)
                    {
                        <tr>
                            <td>@appt.Time</td>
                            <td>@appt.CustomerName</td>
                            <td class="d-none d-xl-table-cell">@appt.ServiceName</td>
                            <td class="d-none d-xl-table-cell"><span class="badge @(appt.Status == AppointmentStatus.Confirmed ? "badge-success-light" : "badge-warning-light")">@appt.Status</span></td>
                            <td class="text-end"><a asp-area="Admin" asp-controller="Appointments" asp-action="Details" asp-route-id="@appt.Id" class="btn btn-light btn-sm">Open</a></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    @* --- TODAY'S SCHEDULE --- *@
    <div class="col-12 col-lg-4 d-flex">
        <div class="card flex-fill w-100">
            <div class="card-header"><h5 class="card-title mb-0">Today's Schedule</h5></div>
            <div class="card-body">
                @{
                    void RenderScheduleBar(string timeLabel, int percentage)
                    {
                        string status = percentage >= 90 ? "Busy" : (percentage >= 50 ? "Almost full" : "Available");
                        string badgeClass = percentage >= 90 ? "badge-danger-light" : (percentage >= 50 ? "badge-warning-light" : "badge-success-light");
                        string progressClass = percentage >= 90 ? "bg-danger" : (percentage >= 50 ? "bg-warning" : "bg-success");

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>@timeLabel</span>
                                <span class="badge @badgeClass">@status</span>
                            </div>
                            <div class="progress progress-sm mt-1">
                                <div class="progress-bar @progressClass" style="width: @percentage%"></div>
                            </div>
                        </div>
                    }

                    RenderScheduleBar("09:00 – 12:00", Model.MorningOccupancy);
                    RenderScheduleBar("12:00 – 15:00", Model.AfternoonOccupancy);
                    RenderScheduleBar("15:00 – 18:00", Model.EveningOccupancy);
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const ctx = document.getElementById("chart-bookings-trend");

            // Fixed: Standardizing on 7 days as the initial state
            const datasets = {
                "7": { labels: @Json.Serialize(Model.ChartLabels7Days), data: @Json.Serialize(Model.ChartValues7Days) },
                "30": { labels: @Json.Serialize(Model.ChartLabels30Days), data: @Json.Serialize(Model.ChartValues30Days) }
            };

            const myChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: datasets["7"].labels,
                    datasets: [{
                        label: "Bookings",
                        fill: true,
                        backgroundColor: "rgba(59, 125, 221, 0.05)",
                        borderColor: "#3b7ddd",
                        data: datasets["7"].data,
                        tension: 0.4,
                        cubicInterpolationMode: 'monotone',
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        borderWidth: 3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0, 
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            grid: { borderDash: [5, 5] }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            document.getElementById("chartFilter").addEventListener("change", function() {
                const newData = datasets[this.value];
                myChart.data.labels = newData.labels;
                myChart.data.datasets[0].data = newData.data;
                myChart.update();
            });

            if (window.feather) { window.feather.replace(); }
        });
    </script>
}