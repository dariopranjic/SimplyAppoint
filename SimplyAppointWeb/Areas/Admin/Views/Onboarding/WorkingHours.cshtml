@model List<WorkingHours>

@{
    ViewData["Title"] = "Working hours";
    Layout = "_OnboardingLayout";
}

<div class="admin-card admin-card-lg">
    <div class="admin-header">
        <div class="admin-badge">Step 3 of 5</div>
        <h1 class="admin-title">Set your availability</h1>
        <p class="admin-subtitle">When is your business open for appointments?</p>
    </div>

    <form asp-action="WorkingHours" method="post" class="admin-form" id="hoursForm">
        <div class="working-hours-container mb-4">
            @{
                var days = Enum.GetValues(typeof(SimplyAppoint.Models.Enums.Weekday)).Cast<SimplyAppoint.Models.Enums.Weekday>().ToList();
            }

            @for (int i = 0; i < days.Count; i++)
            {
                <div class="working-day-row d-flex align-items-center py-3 border-bottom">
                    <div class="day-label fw-bold" style="width: 100px;">
                        @days[i].ToString()
                    </div>

                    <div class="form-check form-switch me-4">
                        <input class="form-check-input day-toggle" type="checkbox" role="switch" id="closed_@i" checked>
                        <label class="form-check-label small text-muted" for="closed_@i">Open</label>
                    </div>

                    <div class="d-flex align-items-center gap-2 flex-grow-1 time-inputs-group">
                        <input type="time" class="form-control admin-input admin-input-sm start-time" value="09:00" />
                        <span class="text-muted">-</span>
                        <input type="time" class="form-control admin-input admin-input-sm end-time" value="17:00" />
                    </div>
                </div>
            }
        </div>

        <div id="timeError" class="text-danger text-center mb-3 d-none" style="font-size: 0.9rem; font-weight: 600;">
            Closing time must be after opening time.
        </div>

        <div class="admin-actions-row mt-4">
            <a asp-action="Services" class="btn btn-outline-secondary admin-btn-soft flex-grow-1">
                Back
            </a>
            <button type="submit" id="submitBtn" class="btn btn-primary admin-btn-primary flex-grow-1">
                Continue
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const form = document.getElementById('hoursForm');
        const submitBtn = document.getElementById('submitBtn');
        const errorMsg = document.getElementById('timeError');

        function validateTimes() {
            let isValid = true;
            const rows = document.querySelectorAll('.working-day-row');

            rows.forEach(row => {
                const toggle = row.querySelector('.day-toggle');
                const startInput = row.querySelector('.start-time');
                const endInput = row.querySelector('.end-time');

                // Reset styles
                startInput.style.borderColor = "";
                endInput.style.borderColor = "";

                if (toggle.checked) {
                    if (startInput.value >= endInput.value) {
                        isValid = false;
                        startInput.style.borderColor = "#dc3545";
                        endInput.style.borderColor = "#dc3545";
                    }
                }
            });

            if (isValid) {
                submitBtn.disabled = false;
                submitBtn.style.opacity = "1";
                errorMsg.classList.add('d-none');
            } else {
                submitBtn.disabled = true;
                submitBtn.style.opacity = "0.5";
                errorMsg.classList.remove('d-none');
            }
        }

        // Toggle logic
        document.querySelectorAll('.day-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const row = this.closest('.working-day-row');
                const inputs = row.querySelectorAll('input[type="time"]');
                const label = row.querySelector('.form-check-label');

                if (this.checked) {
                    inputs.forEach(i => i.disabled = false);
                    label.textContent = "Open";
                    row.style.opacity = "1";
                } else {
                    inputs.forEach(i => i.disabled = true);
                    label.textContent = "Closed";
                    row.style.opacity = "0.5";
                }
                validateTimes(); // Re-validate when toggling
            });
        });

        // Listen for time changes
        document.querySelectorAll('input[type="time"]').forEach(input => {
            input.addEventListener('change', validateTimes);
        });

        // Initial validation run
        validateTimes();
    </script>
}