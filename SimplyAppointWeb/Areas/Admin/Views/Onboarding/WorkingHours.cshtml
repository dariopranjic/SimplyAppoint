@model List<WorkingHours>

@{
    ViewData["Title"] = "Working hours";
    Layout = "_OnboardingLayout";
}

<div class="admin-card admin-card-lg">
    <div class="admin-header">
        <div class="admin-badge">Step 3 of 5</div>
        <h1 class="admin-title">Set your availability</h1>
        <p class="admin-subtitle">When is your business open for appointments?</p>
    </div>

    <form asp-action="WorkingHours" method="post" class="admin-form" id="hoursForm">
        <div class="working-hours-container mb-4">
            @for (int i = 0; i < Model.Count; i++)
            {
                <div class="working-day-row d-flex align-items-center py-3 border-bottom" style="@(Model[i].IsClosed ? "opacity: 0.5;" : "")">

                    @* CRITICAL: Hidden fields for binding *@
                    <input type="hidden" asp-for="@Model[i].Weekday" />
                    <input type="hidden" asp-for="@Model[i].BusinessId" />

                    <div class="day-label fw-bold" style="width: 100px;">
                        @Model[i].Weekday.ToString()
                    </div>

                    <div class="form-check form-switch me-4">
                        @* We use a checkbox for "Open", but we must invert it for "IsClosed" logic in JS or Controller *@
                        <input class="form-check-input day-toggle" type="checkbox" role="switch" id="open_@i" @(Model[i].IsClosed ? "" : "checked")>
                        <input type="hidden" asp-for="@Model[i].IsClosed" class="is-closed-hidden" />
                        <label class="form-check-label small text-muted" for="open_@i">@(Model[i].IsClosed ? "Closed" : "Open")</label>
                    </div>

                    <div class="d-flex align-items-center gap-2 flex-grow-1 time-inputs-group">
                        <input asp-for="@Model[i].OpenTime" type="time" class="form-control admin-input admin-input-sm start-time" disabled="@(Model[i].IsClosed)" />
                        <span class="text-muted">-</span>
                        <input asp-for="@Model[i].CloseTime" type="time" class="form-control admin-input admin-input-sm end-time" disabled="@(Model[i].IsClosed)" />
                    </div>
                </div>
            }
        </div>

        <div id="timeError" class="text-danger text-center mb-3 d-none" style="font-size: 0.9rem; font-weight: 600;">
            Closing time must be after opening time.
        </div>

        <div class="admin-actions-row mt-4">
            <a asp-action="Services" class="btn btn-outline-secondary admin-btn-soft flex-grow-1">
                Back
            </a>
            <button type="submit" id="submitBtn" class="btn btn-primary admin-btn-primary flex-grow-1">
                Continue
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const form = document.getElementById('hoursForm');
        const submitBtn = document.getElementById('submitBtn');
        const errorMsg = document.getElementById('timeError');

        function validateTimes() {
            let isValid = true;
            const rows = document.querySelectorAll('.working-day-row');

            rows.forEach(row => {
                const toggle = row.querySelector('.day-toggle');
                const startInput = row.querySelector('.start-time');
                const endInput = row.querySelector('.end-time');

                startInput.style.borderColor = "";
                endInput.style.borderColor = "";

                // Only validate if NOT closed (toggle is checked means OPEN)
                if (toggle.checked) {
                    if (startInput.value && endInput.value) {
                        if (startInput.value >= endInput.value) {
                            isValid = false;
                            startInput.style.borderColor = "#dc3545";
                            endInput.style.borderColor = "#dc3545";
                        }
                    }
                }
            });

            submitBtn.disabled = !isValid;
            submitBtn.style.opacity = isValid ? "1" : "0.5";
            if (isValid) errorMsg.classList.add('d-none'); else errorMsg.classList.remove('d-none');
        }

        document.querySelectorAll('.day-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const row = this.closest('.working-day-row');
                const inputs = row.querySelectorAll('input[type="time"]');
                const label = row.querySelector('.form-check-label');
                const hiddenIsClosed = row.querySelector('.is-closed-hidden');

                if (this.checked) {
                    inputs.forEach(i => i.disabled = false);
                    label.textContent = "Open";
                    row.style.opacity = "1";
                    hiddenIsClosed.value = "false";
                } else {
                    inputs.forEach(i => i.disabled = true);
                    label.textContent = "Closed";
                    row.style.opacity = "0.5";
                    hiddenIsClosed.value = "true";
                }
                validateTimes();
            });
        });

        document.querySelectorAll('input[type="time"]').forEach(input => {
            input.addEventListener('change', validateTimes);
        });

        validateTimes();
    </script>
}