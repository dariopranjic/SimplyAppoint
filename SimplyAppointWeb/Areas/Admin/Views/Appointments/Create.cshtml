@using SimplyAppoint.Models.Enums
@using SimplyAppoint.Models.ViewModels
@model AppointmentsVM
@{
    ViewData["Title"] = "New Appointment";
    Layout = "_AdminLayout";

    // safe defaults
    var safeDate = !string.IsNullOrWhiteSpace(Model.Date) ? Model.Date : DateTime.Today.ToString("yyyy-MM-dd");
    var safeStart = !string.IsNullOrWhiteSpace(Model.StartTime) ? Model.StartTime : "";
}

<style>
    .sa-chip {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.05);
        color: rgba(255,255,255,.85);
        border-radius: 12px;
        padding: .55rem .75rem;
        font-weight: 700;
        cursor: pointer;
        user-select: none;
        transition: transform .08s ease, background .12s ease, border-color .12s ease;
        text-align: center;
    }

    .sa-chip:hover {
        transform: translateY(-1px);
        background: rgba(255,255,255,.08);
        border-color: rgba(255,255,255,.16);
    }

    .sa-chip.sa-chip-active {
        background: rgba(59,130,246,.22);
        border-color: rgba(59,130,246,.35);
        color: rgba(255,255,255,.95);
    }

    .sa-chip.sa-chip-disabled {
        opacity: .35;
        cursor: not-allowed;
        transform: none !important;
    }

    .sa-summary-pill {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        border-radius: 14px;
        padding: .65rem .75rem;
    }

    .sa-divider {
        height: 1px;
        background: rgba(255,255,255,.08);
        margin: .75rem 0;
    }

    .field-validation-error {
        color: #ffb4b4;
        font-size: .85rem;
        font-weight: 600;
        display: block;
        margin-top: .35rem;
    }

    .validation-summary-errors {
        color: #ffb4b4;
    }

    .card .form-select,
    .card .form-control {
        background-color: rgba(255,255,255,.04);
        border-color: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
    }

    .card .form-select option {
        background: #222e3c;
        color: rgba(255,255,255,.92);
    }

    .input-group-text {
        border-color: rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        color: rgba(255,255,255,.75);
    }

    .sa-slot-empty {
        border: 1px dashed rgba(255,255,255,.18);
        border-radius: 12px;
        padding: .8rem;
        color: rgba(255,255,255,.75);
        text-align: center;
    }

    .sa-policy {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.03);
        border-radius: 14px;
        padding: .75rem .85rem;
    }

    .sa-policy .k {
        color: rgba(255,255,255,.65);
        font-size: .85rem;
    }

    .sa-policy .v {
        font-weight: 700;
        color: rgba(255,255,255,.92);
    }
</style>

<div class="row mb-2 mb-xl-3 align-items-center">
    <div class="col-auto d-none d-sm-block">
        <h3 class="mb-0"><strong>Book Appointment</strong></h3>
        <div class="text-muted">Create a new booking for your customer</div>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="arrow-left"></i> Back
        </a>
        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white">
            <i class="align-middle me-1" data-feather="calendar"></i> Calendar
        </a>
    </div>
</div>

<div class="row">
    <!-- Main form -->
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                        <h5 class="card-title mb-0">Appointment Details</h5>
                        <div class="text-muted">Choose customer, service and time</div>
                    </div>
                    <span class="badge badge-primary-light">New</span>
                </div>
            </div>

            <div class="card-body">
                <form id="saCreateForm"
                      method="post"
                      asp-area="Admin"
                      asp-controller="Appointments"
                      asp-action="Create"
                      novalidate>

                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="ModelOnly" class="mb-3"></div>

                    <!-- Customer -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer name</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="user"></i></span>
                                <input asp-for="CustomerName" class="form-control" placeholder="e.g. Anna K." />
                            </div>
                            <span asp-validation-for="CustomerName"></span>
                            <div class="form-text">Name OR email is enough — email is required only if you want to send emails.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="mail"></i></span>
                                <input asp-for="CustomerEmail" class="form-control" placeholder="name@@domain.com" />
                            </div>
                            <span asp-validation-for="CustomerEmail"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone (optional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="phone"></i></span>
                                <input asp-for="CustomerPhone" class="form-control" placeholder="+385 ..." />
                            </div>
                            <span asp-validation-for="CustomerPhone"></span>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select asp-for="Status"
                                    class="form-select"
                                    asp-items="Html.GetEnumSelectList<AppointmentStatus>()">
                            </select>
                            <span asp-validation-for="Status"></span>
                            <div class="form-text">Tip: use <strong>Pending</strong> if you still need to confirm.</div>
                        </div>
                    </div>

                    <div class="sa-divider"></div>

                    <!-- Service -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Service</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="briefcase"></i></span>
                                <select asp-for="ServiceId"
                                        class="form-select"
                                        asp-items="Model.ServiceOptions"
                                        id="svcSelect">
                                    <option value="">Select service…</option>
                                </select>
                            </div>
                            <span asp-validation-for="ServiceId"></span>
                            <div class="form-text">Pick a service + date to load available times.</div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price override (optional)</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="PriceOverride" class="form-control" type="number" step="0.01" min="0" id="priceInput" />
                            </div>
                            <span asp-validation-for="PriceOverride"></span>
                            <div class="form-text">Leave empty to use service price.</div>
                        </div>
                    </div>

                    <!-- Scheduling -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="calendar"></i></span>
                                <input asp-for="Date" class="form-control" type="date" id="dateInput" value="@safeDate" />
                            </div>
                            <span asp-validation-for="Date"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Start time</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="clock"></i></span>
                                <input asp-for="StartTime" class="form-control" type="time" id="startTimeInput" value="@safeStart" />
                            </div>
                            <span asp-validation-for="StartTime"></span>
                            <div class="form-text">Click a slot on the right to fill this.</div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Duration (minutes)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="hash"></i></span>
                                <input asp-for="DurationMinutes" class="form-control" type="number" min="1" max="1440" id="durInput" />
                            </div>
                            <span asp-validation-for="DurationMinutes"></span>
                            <div class="form-text">If empty, controller will fallback to service duration.</div>
                        </div>
                    </div>

                    <div class="sa-divider"></div>

                    <!-- Notes -->
                    <div class="row">
                        <div class="col-12 mb-2">
                            <label class="form-label">Notes (optional)</label>
                            <textarea asp-for="Notes"
                                      class="form-control"
                                      rows="4"
                                      placeholder="e.g., customer preference, special request, internal note…"
                                      id="notesInput"></textarea>
                            <span asp-validation-for="Notes"></span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
                        <a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-outline-light">
                            Cancel
                        </a>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="align-middle me-1" data-feather="check"></i> Create Appointment
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right column -->
    <div class="col-12 col-lg-4 d-flex">
        <div class="d-flex flex-column w-100">

            <!-- Summary -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <div class="sa-summary-pill">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Customer</span>
                            <span class="fw-semibold" id="sumCustomer">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Service</span>
                            <span class="fw-semibold" id="sumService">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">When</span>
                            <span class="fw-semibold" id="sumWhen">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Duration</span>
                            <span class="fw-semibold" id="sumDuration">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Price</span>
                            <span class="fw-semibold" id="sumPrice">—</span>
                        </div>
                    </div>

                    <div class="d-grid mt-3">
                        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white">
                            <i class="align-middle me-2" data-feather="external-link"></i> View in Calendar
                        </a>
                    </div>
                </div>
            </div>

            <!-- Available times -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Available Times</h5>
                        <span class="badge badge-success-light" id="slotsBadge">Select service</span>
                    </div>
                </div>

                <div class="card-body pt-2">
                    <div class="text-muted small mb-2">Pick a service + date. Then click a slot to fill Start time.</div>

                    @if (!string.IsNullOrWhiteSpace(Model.AvailabilityMessage))
                    {
                        <div class="sa-slot-empty mb-2">@Model.AvailabilityMessage</div>
                    }

                    <div id="slotsEmpty" class="sa-slot-empty d-none">
                        No available slots for this date.
                    </div>

                    <div class="row g-2" id="slotsGrid">
                        @if (Model.AvailableTimes != null && Model.AvailableTimes.Any())
                        {
                            foreach (var t in Model.AvailableTimes.Take(Model.MaxSlotsToShow > 0 ? Model.MaxSlotsToShow : 9))
                            {
                                <div class="col-4">
                                    <div class="sa-chip" data-time="@t">@t</div>
                                </div>
                            }

                            if (Model.AvailableTimes.Count > (Model.MaxSlotsToShow > 0 ? Model.MaxSlotsToShow : 9))
                            {
                                <div class="col-12 text-muted small mt-2">
                                    Showing @(Model.MaxSlotsToShow > 0 ? Model.MaxSlotsToShow : 9) of @Model.AvailableTimes.Count available slots.
                                </div>
                            }
                        }
                    </div>

                    <div class="text-muted small mt-3" id="slotsHint">
                        Slots are loaded from your booking logic (working hours, time off, buffers).
                    </div>
                </div>
            </div>

            <!-- Booking rules -->
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Booking Rules</h5>
                </div>
                <div class="card-body">
                    <div class="sa-policy">
                        <div class="d-flex justify-content-between">
                            <div class="k">Slot interval</div>
                            <div class="v">@Model.SlotIntervalMinutes min</div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div class="k">Advance notice</div>
                            <div class="v">@Model.AdvanceNoticeMinutes min</div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div class="k">Cancellation window</div>
                            <div class="v">@Model.CancellationWindowMinutes min</div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div class="k">Max advance</div>
                            <div class="v">@Model.MaxAdvanceDays day(s)</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const customerName = document.getElementById("CustomerName");
            const customerEmail = document.getElementById("CustomerEmail");
            const svcSelect = document.getElementById("svcSelect");
            const dateInput = document.getElementById("dateInput");
            const startTimeInput = document.getElementById("startTimeInput");
            const durInput = document.getElementById("durInput");
            const priceInput = document.getElementById("priceInput");

            const sumCustomer = document.getElementById("sumCustomer");
            const sumService = document.getElementById("sumService");
            const sumWhen = document.getElementById("sumWhen");
            const sumDuration = document.getElementById("sumDuration");
            const sumPrice = document.getElementById("sumPrice");

            const slotsBadge = document.getElementById("slotsBadge");
            const slotsGrid = document.getElementById("slotsGrid");
            const slotsEmpty = document.getElementById("slotsEmpty");

            const endpoint = '@Url.Action("GetAvailableSlots", "Home", new { area = "Customer" })';

            function fmtWhenLabel() {
                const d = dateInput?.value || "";
                const t = startTimeInput?.value || "";
                if (!d && !t) return "—";
                if (d && t) return d + " @@ " + t;
                return d || t;
            }

            function selectedServiceText() {
                const opt = svcSelect?.options?.[svcSelect.selectedIndex];
                if (!opt || !opt.value) return "—";
                return opt.text;
            }

            function refreshSummary() {
                const cname = customerName?.value?.trim() || "";
                const cemail = customerEmail?.value?.trim() || "";

                if (cname) sumCustomer.textContent = cname;
                else if (cemail) sumCustomer.textContent = cemail;
                else sumCustomer.textContent = "—";

                sumService.textContent = selectedServiceText();
                sumWhen.textContent = fmtWhenLabel();

                const dur = durInput?.value?.trim() || "";
                sumDuration.textContent = dur ? (dur + " min") : "—";

                const price = priceInput?.value?.trim() || "";
                sumPrice.textContent = price ? ("€ " + price) : "—";
            }

            function setBadge(text) {
                if (slotsBadge) slotsBadge.textContent = text;
            }

            function renderSlots(times) {
                if (!slotsGrid || !slotsEmpty) return;

                slotsGrid.innerHTML = "";
                slotsEmpty.classList.add("d-none");

                if (!Array.isArray(times) || times.length === 0) {
                    slotsEmpty.classList.remove("d-none");
                    return;
                }

                const maxShow = 9; 
                const show = times.slice(0, maxShow);

                for (const t of show) {
                    const col = document.createElement("div");
                    col.className = "col-4";

                    const chip = document.createElement("div");
                    chip.className = "sa-chip";
                    chip.setAttribute("data-time", t);
                    chip.textContent = t;

                    if (startTimeInput?.value === t) chip.classList.add("sa-chip-active");

                    chip.addEventListener("click", function () {
                        if (!startTimeInput) return;
                        startTimeInput.value = t;

                        slotsGrid.querySelectorAll(".sa-chip").forEach(x => x.classList.remove("sa-chip-active"));
                        chip.classList.add("sa-chip-active");

                        refreshSummary();
                    });

                    col.appendChild(chip);
                    slotsGrid.appendChild(col);
                }

                if (times.length > show.length) {
                    const hint = document.createElement("div");
                    hint.className = "col-12 text-muted small mt-2";
                    hint.textContent = `Showing ${show.length} of ${times.length} available slots.`;
                    slotsGrid.appendChild(hint);
                }
            }

            async function loadSlots() {
                const serviceId = svcSelect?.value;
                const date = dateInput?.value;

                if (!serviceId) {
                    setBadge("Select service");
                    renderSlots([]);
                    return;
                }
                if (!date) {
                    setBadge("Pick date");
                    renderSlots([]);
                    return;
                }

                setBadge("Loading…");

                try {
                    const url = `${endpoint}?serviceId=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(date)}`;
                    const res = await fetch(url, { headers: { "Accept": "application/json" } });
                    if (!res.ok) throw new Error("Failed");
                    const data = await res.json();

                    setBadge("Ready");
                    renderSlots(data);
                } catch (e) {
                    setBadge("Error");
                    renderSlots([]);
                }
            }

            // hooks
            ["input", "change"].forEach(evt => {
                customerName?.addEventListener(evt, refreshSummary);
                customerEmail?.addEventListener(evt, refreshSummary);
                svcSelect?.addEventListener(evt, function () { refreshSummary(); loadSlots(); });
                dateInput?.addEventListener(evt, function () { refreshSummary(); loadSlots(); });
                startTimeInput?.addEventListener(evt, refreshSummary);
                durInput?.addEventListener(evt, refreshSummary);
                priceInput?.addEventListener(evt, refreshSummary);
            });

            // initial
            refreshSummary();
            loadSlots();

            if (window.feather) window.feather.replace();
        })();
    </script>
}