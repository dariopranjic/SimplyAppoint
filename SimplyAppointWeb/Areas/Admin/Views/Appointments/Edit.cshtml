@using SimplyAppoint.Models.Enums
@using SimplyAppoint.Models.ViewModels
@model AppointmentsVM
@{
    ViewData["Title"] = "Edit Appointment";
    Layout = "_AdminLayout";

    // safe defaults
    var safeDate = !string.IsNullOrWhiteSpace(Model.Date) ? Model.Date : DateTime.Today.ToString("yyyy-MM-dd");
    var safeStart = !string.IsNullOrWhiteSpace(Model.StartTime) ? Model.StartTime : "";

    var isCustomerBooked = !string.IsNullOrWhiteSpace(Model.AvailabilityMessage)
                           && Model.AvailabilityMessage.Contains("booked by a customer", StringComparison.OrdinalIgnoreCase);

    var isCancelled = Model.Status == AppointmentStatus.Cancelled;
    var isNoShow = Model.Status == AppointmentStatus.NoShow;
    var isCompleted = Model.Status == AppointmentStatus.Completed;
    var isPending = Model.Status == AppointmentStatus.Pending;

    var isLocked = isCancelled || isCompleted || isNoShow || isPending;

    var canEditSchedule = !isLocked && !isCustomerBooked;

    DateTime localStart;
    DateTime localEnd;
    var startOk = DateTime.TryParseExact($"{safeDate} {safeStart}", "yyyy-MM-dd HH:mm",
        System.Globalization.CultureInfo.InvariantCulture,
        System.Globalization.DateTimeStyles.None, out localStart);

    var endOk = startOk && (Model.DurationMinutes.HasValue && Model.DurationMinutes.Value > 0);
    localEnd = endOk ? localStart.AddMinutes(Model.DurationMinutes!.Value) : DateTime.MaxValue;

    var canMarkNoShow = !isLocked && isCompleted && endOk && localEnd <= DateTime.Now.AddMinutes(-1);

    string StatusBadgeClass(AppointmentStatus s)
    {
        return s switch
        {
            AppointmentStatus.Confirmed => "badge-success-light",
            AppointmentStatus.Pending => "badge-warning-light",
            AppointmentStatus.Cancelled => "badge-danger-light",
            AppointmentStatus.NoShow => "badge-dark-light",
            AppointmentStatus.Completed => "badge-info-light",
            _ => "badge-primary-light"
        };
    }

    string StatusLabel(AppointmentStatus s) => s switch
    {
        AppointmentStatus.NoShow => "No show",
        _ => s.ToString()
    };
}

<style>
    .sa-chip {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.05);
        color: rgba(255,255,255,.85);
        border-radius: 12px;
        padding: .55rem .75rem;
        font-weight: 700;
        cursor: pointer;
        user-select: none;
        transition: transform .08s ease, background .12s ease, border-color .12s ease;
        text-align: center;
    }

    .sa-chip:hover {
        transform: translateY(-1px);
        background: rgba(255,255,255,.08);
        border-color: rgba(255,255,255,.16);
    }

    .sa-chip.sa-chip-active {
        background: rgba(59,130,246,.22);
        border-color: rgba(59,130,246,.35);
        color: rgba(255,255,255,.95);
    }

    .sa-chip.sa-chip-disabled {
        opacity: .35;
        cursor: not-allowed;
        transform: none !important;
    }

    .sa-summary-pill {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        border-radius: 14px;
        padding: .65rem .75rem;
    }

    .sa-divider {
        height: 1px;
        background: rgba(255,255,255,.08);
        margin: .75rem 0;
    }

    .field-validation-error {
        color: #ffb4b4;
        font-size: .85rem;
        font-weight: 600;
        display: block;
        margin-top: .35rem;
    }

    .validation-summary-errors {
        color: #ffb4b4;
    }

    .card .form-select,
    .card .form-control {
        background-color: rgba(255,255,255,.04);
        border-color: rgba(255,255,255,.10);
        color: rgba(255,255,255,.92);
    }

    .card .form-select option {
        background: #222e3c;
        color: rgba(255,255,255,.92);
    }

    .input-group-text {
        border-color: rgba(255,255,255,.10);
        background: rgba(255,255,255,.04);
        color: rgba(255,255,255,.75);
    }

    .sa-slot-empty {
        border: 1px dashed rgba(255,255,255,.18);
        border-radius: 12px;
        padding: .8rem;
        color: rgba(255,255,255,.75);
        text-align: center;
    }

    .sa-slots-toolbar {
        display: none;
        align-items: center;
        justify-content: space-between;
        gap: .5rem;
        margin-bottom: .5rem;
    }

    .sa-slots-toolbar.sa-show {
        display: flex;
    }

    .sa-slots-toolbar .btn {
        border-radius: 10px;
        padding: .35rem .55rem;
        line-height: 1.1;
        border-color: rgba(255,255,255,.25);
        color: rgba(255,255,255,.75);
        background: rgba(255,255,255,.04);
    }

    .sa-slots-toolbar .btn:hover {
        background: rgba(255,255,255,.10);
        border-color: rgba(255,255,255,.40);
        color: rgba(255,255,255,.90);
    }

    .sa-slots-toolbar .btn:disabled {
        opacity: .35;
        cursor: not-allowed;
    }

    .sa-slots-meta {
        font-size: .82rem;
        color: rgba(255,255,255,.65);
        white-space: nowrap;
    }

    .sa-lockbox {
        border: 1px solid rgba(255,255,255,.10);
        background: rgba(255,255,255,.03);
        border-radius: 14px;
        padding: .75rem .85rem;
        color: rgba(255,255,255,.80);
    }

    .sa-lockbox .t {
        font-weight: 800;
        color: rgba(255,255,255,.92);
    }

    .sa-actions .btn:disabled {
        opacity: .35;
        cursor: not-allowed;
    }

    .sa-modal {
        position: fixed;
        inset: 0;
        z-index: 1055;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .sa-modal.sa-open {
        display: flex;
    }

    .sa-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(4px);
    }

    .sa-modal-card {
        position: relative;
        width: 100%;
        max-width: 520px;
        background: #222e3c;
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 18px;
        box-shadow: 0 18px 55px rgba(0,0,0,.55);
        overflow: hidden;
        transform: translateY(6px);
        animation: saPop .14s ease-out forwards;
    }

    @@keyframes saPop {
        to {
            transform: translateY(0);
        }
    }

    .sa-modal-head {
        padding: 18px 20px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .sa-modal-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 800;
        color: rgba(255,255,255,.92);
    }

    .sa-modal-close {
        background: transparent;
        border: 0;
        color: rgba(255,255,255,.75);
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .sa-modal-close:hover {
        background: rgba(255,255,255,.06);
    }

    .sa-modal-body {
        padding: 18px 20px 6px 20px;
        color: rgba(255,255,255,.86);
    }

    .sa-modal-body .text-muted {
        color: rgba(255,255,255,.60) !important;
    }

    .sa-modal-foot {
        padding: 14px 20px 18px 20px;
        display: flex;
        justify-content: flex-end;
        gap: .5rem;
        border-top: 1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.02);
    }

    .sa-pill {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .35rem .6rem;
        border-radius: 999px;
        font-weight: 700;
        font-size: .78rem;
        border: 1px solid rgba(255,255,255,.10);
        color: rgba(255,255,255,.86);
        background: rgba(255,255,255,.04);
        white-space: nowrap;
    }
</style>

<div class="row mb-2 mb-xl-3 align-items-center">
    <div class="col-auto d-none d-sm-block">
        <h3 class="mb-0"><strong>Edit Appointment</strong></h3>
        <div class="text-muted">Update details, status and notes</div>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="arrow-left"></i> Back
        </a>
        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="calendar"></i> Calendar
        </a>

        <button type="submit" form="saEditForm" class="btn btn-primary" disabled="@(isLocked)">
            <i class="align-middle me-1" data-feather="save"></i> Save changes
        </button>
    </div>
</div>

<div class="row">
    <!-- Main: Edit form -->
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                        <h5 class="card-title mb-0">Appointment Details</h5>
                        <div class="text-muted">ID: #@Model.Id</div>
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span class="badge @StatusBadgeClass(Model.Status)">@StatusLabel(Model.Status)</span>
                        @if (isCustomerBooked)
                        {
                            <span class="badge badge-primary-light">Customer booked</span>
                        }
                        else
                        {
                            <span class="badge badge-primary-light">Owner created</span>
                        }
                    </div>
                </div>
            </div>

            <div class="card-body">
                @if (isLocked)
                {
                    <div class="sa-lockbox mb-3">
                        <div class="t">This appointment is locked.</div>
                        <div class="text-muted small mt-1">
                            Pending, Cancelled, Completed and No-show appointments cannot be edited.
                        </div>
                    </div>
                }

                <form id="saEditForm"
                      method="post"
                      asp-area="Admin"
                      asp-controller="Appointments"
                      asp-action="Edit"
                      asp-route-id="@Model.Id"
                      novalidate>

                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="mb-3"></div>
                    <input asp-for="Id" type="hidden" />

                    <!-- Customer -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer name</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="user"></i></span>
                                <input asp-for="CustomerName"
                                       class="form-control"
                                       placeholder="e.g. Anna K."
                                       disabled="@(isLocked || isCustomerBooked)" />
                            </div>
                            <span asp-validation-for="CustomerName"></span>

                            @if (isLocked || isCustomerBooked)
                            {
                                <input type="hidden" asp-for="CustomerName" />
                            }
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="mail"></i></span>
                                <input asp-for="CustomerEmail"
                                       class="form-control"
                                       placeholder="name@domain.com"
                                       disabled="@(isLocked || isCustomerBooked)" />
                            </div>
                            <span asp-validation-for="CustomerEmail"></span>

                            @if (isLocked || isCustomerBooked)
                            {
                                <input type="hidden" asp-for="CustomerEmail" />
                            }
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone (optional)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="phone"></i></span>
                                <input asp-for="CustomerPhone"
                                       class="form-control"
                                       placeholder="+385 ..."
                                       disabled="@(isLocked || isCustomerBooked)" />
                            </div>
                            <span asp-validation-for="CustomerPhone"></span>

                            @if (isLocked || isCustomerBooked)
                            {
                                <input type="hidden" asp-for="CustomerPhone" />
                            }
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>

                            <select asp-for="Status"
                                    class="form-select"
                                    asp-items="Html.GetEnumSelectList<AppointmentStatus>()"
                                    id="statusSelect"
                                    disabled="@(isLocked)">
                            </select>

                            <span asp-validation-for="Status"></span>

                            @if (isLocked)
                            {
                                <input type="hidden" asp-for="Status" />
                            }

                            <div class="form-text">
                                @if (isCustomerBooked)
                                {
                                    <span>Customer-booked appointments: only status changes are allowed (controller enforces rules).</span>
                                }
                                else
                                {
                                    <span>Status is shown on Calendar & Appointments list.</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="sa-divider"></div>

                    <!-- Service + Price -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Service</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="briefcase"></i></span>
                                <select asp-for="ServiceId"
                                        class="form-select"
                                        asp-items="Model.ServiceOptions"
                                        id="svcSelect"
                                        disabled="@(!canEditSchedule)">
                                    <option value="">Select service…</option>
                                </select>
                            </div>
                            <span asp-validation-for="ServiceId"></span>

                            @if (!string.IsNullOrWhiteSpace(Model.ServiceLabel))
                            {
                                <div class="form-text">Current: <strong>@Model.ServiceLabel</strong></div>
                            }

                            @if (!canEditSchedule)
                            {
                                <input type="hidden" asp-for="ServiceId" />
                            }
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price override (optional)</label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="PriceOverride"
                                       class="form-control"
                                       type="number"
                                       step="0.01"
                                       min="0"
                                       id="priceInput"
                                       disabled="@(!canEditSchedule)" />
                            </div>
                            <span asp-validation-for="PriceOverride"></span>
                            <div class="form-text">Leave empty to use service price.</div>

                            @if (!canEditSchedule)
                            {
                                <input type="hidden" asp-for="PriceOverride" />
                            }
                        </div>
                    </div>

                    <!-- Scheduling -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="calendar"></i></span>
                                <input asp-for="Date"
                                       class="form-control"
                                       type="date"
                                       id="dateInput"
                                       value="@safeDate"
                                       disabled="@(!canEditSchedule)" />
                            </div>
                            <span asp-validation-for="Date"></span>

                            @if (!canEditSchedule)
                            {
                                <input type="hidden" asp-for="Date" value="@safeDate" />
                            }
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Start time</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="clock"></i></span>
                                <input asp-for="StartTime"
                                       class="form-control"
                                       type="time"
                                       id="startTimeInput"
                                       value="@safeStart"
                                       disabled="@(!canEditSchedule)" />
                            </div>
                            <span asp-validation-for="StartTime"></span>

                            <div class="form-text">
                                @(canEditSchedule ? "Click a slot on the right to fill this." : "Time cannot be changed for this appointment.")
                            </div>

                            @if (!canEditSchedule)
                            {
                                <input type="hidden" asp-for="StartTime" value="@safeStart" />
                            }
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Duration (minutes)</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="align-middle" data-feather="hash"></i></span>
                                <input asp-for="DurationMinutes"
                                       class="form-control"
                                       type="number"
                                       min="1"
                                       max="1440"
                                       id="durInput"
                                       disabled="@(!canEditSchedule)" />
                            </div>
                            <span asp-validation-for="DurationMinutes"></span>
                            <div class="form-text">If empty, controller will fallback to service duration.</div>

                            @if (!canEditSchedule)
                            {
                                <input type="hidden" asp-for="DurationMinutes" />
                            }
                        </div>
                    </div>

                    <div class="sa-divider"></div>

                    <!-- Notes -->
                    <div class="row">
                        <div class="col-12 mb-2">
                            <label class="form-label">Internal Notes</label>
                            <textarea asp-for="Notes"
                                      class="form-control"
                                      rows="4"
                                      placeholder="Preferences, warnings, internal notes…"
                                      id="notesInput"
                                      disabled="@(isLocked)"></textarea>
                            <span asp-validation-for="Notes"></span>

                            @if (isLocked)
                            {
                                <input type="hidden" asp-for="Notes" />
                            }
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
                        <a asp-area="Admin" asp-controller="Appointments" asp-action="Index" class="btn btn-outline-light">
                            Back to list
                        </a>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@(isLocked)">
                                <i class="align-middle me-1" data-feather="save"></i> Save changes
                            </button>
                        </div>
                    </div>
                </form>

                <form id="saCancelForm-@Model.Id"
                      class="d-none"
                      method="post"
                      asp-area="Admin"
                      asp-controller="Appointments"
                      asp-action="Cancel"
                      asp-route-id="@Model.Id">
                    @Html.AntiForgeryToken()
                </form>

                <form id="saNoshowForm-@Model.Id"
                      class="d-none"
                      method="post"
                      asp-area="Admin"
                      asp-controller="Appointments"
                      asp-action="MarkNoShow"
                      asp-route-id="@Model.Id">
                    @Html.AntiForgeryToken()
                </form>
            </div>
        </div>
    </div>

    <!-- Right: Summary + helpers -->
    <div class="col-12 col-lg-4 d-flex">
        <div class="d-flex flex-column w-100">

            <!-- Summary -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <div class="sa-summary-pill">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Customer</span>
                            <span class="fw-semibold" id="sumCustomer">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Service</span>
                            <span class="fw-semibold" id="sumService">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">When</span>
                            <span class="fw-semibold" id="sumWhen">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Duration</span>
                            <span class="fw-semibold" id="sumDuration">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Price</span>
                            <span class="fw-semibold" id="sumPrice">—</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="text-muted">Status</span>
                            <span class="badge @StatusBadgeClass(Model.Status)" id="sumStatus">@StatusLabel(Model.Status)</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-3">
                        <a asp-area="Admin" asp-controller="Customers" asp-action="Index" class="btn btn-light bg-white">
                            <i class="align-middle me-1" data-feather="users"></i> Open customers
                        </a>
                        <a asp-area="Admin" asp-controller="Services" asp-action="Index" class="btn btn-light bg-white">
                            <i class="align-middle me-1" data-feather="briefcase"></i> Open services
                        </a>
                    </div>
                </div>
            </div>

            <!-- Available times -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Available Times</h5>
                        <span class="badge badge-success-light" id="slotsBadge">—</span>
                    </div>
                </div>

                <div class="card-body pt-2">
                    @if (!canEditSchedule)
                    {
                        <div class="sa-slot-empty">
                            @(!string.IsNullOrWhiteSpace(Model.AvailabilityMessage)
                                                    ? Model.AvailabilityMessage
                                                    : "Time selection is not available for this appointment.")
                        </div>
                    }
                    else
                    {
                        <div class="text-muted small mb-2">Pick a service + date. Use arrows to browse slots. Click a slot to fill Start time.</div>

                        <div class="sa-slots-toolbar" id="slotsToolbar">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-light" id="slotsPrev" aria-label="Previous slots">
                                    <i data-feather="chevron-left"></i>
                                </button>
                                <button type="button" class="btn btn-outline-light" id="slotsNext" aria-label="Next slots">
                                    <i data-feather="chevron-right"></i>
                                </button>
                            </div>
                            <div class="sa-slots-meta" id="slotsMeta">—</div>
                        </div>

                        <div id="slotsEmpty" class="sa-slot-empty d-none">
                            No available slots for this date.
                        </div>

                        <div class="row g-2" id="slotsGrid"></div>
                    }
                </div>
            </div>

            <!-- Quick actions -->
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body sa-actions">
                    <div class="d-grid gap-2">
                        <button type="button"
                                class="btn btn-outline-danger"
                                id="qaCancel"
                                disabled="@(isLocked)">
                            <i class="align-middle me-1" data-feather="x-circle"></i> Cancel appointment
                        </button>

                        <button type="button"
                                class="btn btn-outline-warning"
                                id="qaNoShow"
                                disabled="@(!canMarkNoShow)">
                            <i class="align-middle me-1" data-feather="user-x"></i> Mark as No show
                        </button>
                    </div>

                    <hr class="my-3" />

                    <div class="text-muted small">
                        @if (!canMarkNoShow)
                        {
                            <div>
                                Tip: <strong>No show</strong> is only allowed after the appointment ended and when status is <strong>Completed</strong>.
                            </div>
                        }
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Reusable centered modal -->
<div class="sa-modal" id="saModal" aria-hidden="true">
    <div class="sa-modal-backdrop" data-sa-close></div>

    <div class="sa-modal-card" role="dialog" aria-modal="true" aria-labelledby="saModalTitle">
        <div class="sa-modal-head">
            <div>
                <h5 class="sa-modal-title" id="saModalTitle">Confirm</h5>
                <div class="text-muted small" id="saModalSubtitle">—</div>
            </div>
            <button type="button" class="sa-modal-close" data-sa-close aria-label="Close">
                <i data-feather="x"></i>
            </button>
        </div>

        <div class="sa-modal-body">
            <div id="saModalMessage" class="mb-2">—</div>

            <div class="d-flex flex-wrap gap-2 mt-3">
                <span class="sa-pill" id="saModalPill">
                    <i data-feather="alert-triangle"></i>
                    <span id="saModalPillText">Action</span>
                </span>
                <span class="sa-pill">
                    <i data-feather="hash"></i>
                    <span>Appointment ID:</span>
                    <span class="fw-bold" id="saModalId">—</span>
                </span>
            </div>
        </div>

        <div class="sa-modal-foot">
            <button type="button" class="btn btn-outline-light" data-sa-close>Cancel</button>
            <button type="button" class="btn btn-danger" id="saModalConfirmBtn">
                Confirm
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
            const customerName = document.getElementById("CustomerName");
            const customerEmail = document.getElementById("CustomerEmail");
            const svcSelect = document.getElementById("svcSelect");
            const dateInput = document.getElementById("dateInput");
            const startTimeInput = document.getElementById("startTimeInput");
            const durInput = document.getElementById("durInput");
            const priceInput = document.getElementById("priceInput");
            const statusSelect = document.getElementById("statusSelect");

            const sumCustomer = document.getElementById("sumCustomer");
            const sumService = document.getElementById("sumService");
            const sumWhen = document.getElementById("sumWhen");
            const sumDuration = document.getElementById("sumDuration");
            const sumPrice = document.getElementById("sumPrice");
            const sumStatus = document.getElementById("sumStatus");

            function statusBadgeClass(statusText) {
                switch ((statusText || "").toLowerCase()) {
                    case "confirmed": return "badge-success-light";
                    case "pending": return "badge-warning-light";
                    case "cancelled": return "badge-danger-light";
                    case "noshow": return "badge-dark-light";
                    case "completed": return "badge-info-light";
                    default: return "badge-primary-light";
                }
            }

            function fmtWhenLabel() {
                const d = dateInput?.value || "";
                const t = startTimeInput?.value || "";
                if (!d && !t) return "—";
                if (d && t) return d + " @@" + t;
                return d || t;
            }

            function selectedServiceText() {
                const opt = svcSelect?.options?.[svcSelect.selectedIndex];
                if (!opt || !opt.value) return "—";
                return opt.text;
            }

            function refreshSummary() {
                const cname = customerName?.value?.trim() || "";
                const cemail = customerEmail?.value?.trim() || "";

                if (sumCustomer) {
                    if (cname) sumCustomer.textContent = cname;
                    else if (cemail) sumCustomer.textContent = cemail;
                    else sumCustomer.textContent = "—";
                }

                if (sumService) sumService.textContent = selectedServiceText();
                if (sumWhen) sumWhen.textContent = fmtWhenLabel();

                const dur = durInput?.value?.trim() || "";
                if (sumDuration) sumDuration.textContent = dur ? (dur + " min") : "—";

                const price = priceInput?.value?.trim() || "";
                if (sumPrice) sumPrice.textContent = price ? ("€ " + price) : "—";

                const st = statusSelect?.value || "";
                if (sumStatus) {
                    sumStatus.textContent = st || "—";
                    sumStatus.className = "badge " + statusBadgeClass(st);
                }
            }

            const slotsBadge = document.getElementById("slotsBadge");
            const slotsGrid = document.getElementById("slotsGrid");
            const slotsEmpty = document.getElementById("slotsEmpty");

            const toolbar = document.getElementById("slotsToolbar");
            const btnPrev = document.getElementById("slotsPrev");
            const btnNext = document.getElementById("slotsNext");
            const meta = document.getElementById("slotsMeta");

            const endpoint = '@Url.Action("GetAvailableSlots", "Appointments", new { area = "Admin" })';

            const PAGE_SIZE = 9;
            let allTimes = [];
            let pageIndex = 0;

            function setBadge(text) {
                if (slotsBadge) slotsBadge.textContent = text;
            }

            function updatePager() {
                if (!toolbar || !btnPrev || !btnNext || !meta) return;

                const total = allTimes.length;
                const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));

                if (total > PAGE_SIZE) toolbar.classList.add("sa-show");
                else toolbar.classList.remove("sa-show");

                btnPrev.disabled = (pageIndex <= 0);
                btnNext.disabled = (pageIndex >= pages - 1);

                const from = total === 0 ? 0 : (pageIndex * PAGE_SIZE + 1);
                const to = Math.min(total, (pageIndex + 1) * PAGE_SIZE);

                meta.textContent = total === 0 ? "—" : `Showing ${from}–${to} of ${total}`;
            }

            function renderPage() {
                if (!slotsGrid || !slotsEmpty) return;

                slotsGrid.innerHTML = "";
                slotsEmpty.classList.add("d-none");

                if (!Array.isArray(allTimes) || allTimes.length === 0) {
                    slotsEmpty.classList.remove("d-none");
                    updatePager();
                    return;
                }

                const start = pageIndex * PAGE_SIZE;
                const show = allTimes.slice(start, start + PAGE_SIZE);

                for (const t of show) {
                    const col = document.createElement("div");
                    col.className = "col-4";

                    const chip = document.createElement("div");
                    chip.className = "sa-chip";
                    chip.setAttribute("data-time", t);
                    chip.textContent = t;

                    if (startTimeInput?.value === t) chip.classList.add("sa-chip-active");

                    chip.addEventListener("click", function () {
                        if (!startTimeInput) return;
                        startTimeInput.value = t;

                        slotsGrid.querySelectorAll(".sa-chip").forEach(x => x.classList.remove("sa-chip-active"));
                        chip.classList.add("sa-chip-active");

                        refreshSummary();
                    });

                    col.appendChild(chip);
                    slotsGrid.appendChild(col);
                }

                updatePager();
            }

            async function loadSlots() {
                if (!slotsGrid || !slotsEmpty || !svcSelect || !dateInput) return;

                const serviceId = svcSelect.value;
                const date = dateInput.value;

                if (!serviceId) {
                    setBadge("Select service");
                    allTimes = [];
                    pageIndex = 0;
                    renderPage();
                    return;
                }
                if (!date) {
                    setBadge("Pick date");
                    allTimes = [];
                    pageIndex = 0;
                    renderPage();
                    return;
                }

                setBadge("Loading…");

                try {
                    const url = `${endpoint}?serviceId=${encodeURIComponent(serviceId)}&date=${encodeURIComponent(date)}`;
                    const res = await fetch(url, { headers: { "Accept": "application/json" } });
                    if (!res.ok) throw new Error("Failed");
                    const data = await res.json();

                    allTimes = Array.isArray(data) ? data : [];
                    pageIndex = 0;

                    setBadge(allTimes.length ? "Ready" : "No slots");
                    renderPage();
                } catch (e) {
                    setBadge("Error");
                    allTimes = [];
                    pageIndex = 0;
                    renderPage();
                }
            }

            btnPrev?.addEventListener("click", function () {
                if (pageIndex <= 0) return;
                pageIndex--;
                renderPage();
            });

            btnNext?.addEventListener("click", function () {
                const pages = Math.max(1, Math.ceil(allTimes.length / PAGE_SIZE));
                if (pageIndex >= pages - 1) return;
                pageIndex++;
                renderPage();
            });

            const modal = document.getElementById("saModal");
            const titleEl = document.getElementById("saModalTitle");
            const subtitleEl = document.getElementById("saModalSubtitle");
            const msgEl = document.getElementById("saModalMessage");
            const pillTextEl = document.getElementById("saModalPillText");
            const idEl = document.getElementById("saModalId");
            const confirmBtn = document.getElementById("saModalConfirmBtn");

            const qaCancel = document.getElementById("qaCancel");
            const qaNoShow = document.getElementById("qaNoShow");

            let currentFormId = null;

            const presets = {
                cancel: {
                    title: "Cancel appointment?",
                    subtitle: "This will permanently cancel the booking.",
                    message: "The customer will be notified by email (if an email exists). You can’t reopen a cancelled appointment.",
                    pill: "Cancel",
                    btnClass: "btn-danger",
                    btnText: "Yes, cancel"
                },
                noshow: {
                    title: "Mark as No show?",
                    subtitle: "Only do this if the customer did not come.",
                    message: "No show appointments are excluded from revenue.",
                    pill: "No show",
                    btnClass: "btn-warning",
                    btnText: "Yes, mark No show"
                }
            };

            function openModal(kind, id) {
                const p = presets[kind];
                if (!p || !modal) return;

                currentFormId = (kind === "cancel")
                    ? `saCancelForm-${id}`
                    : `saNoshowForm-${id}`;

                titleEl.textContent = p.title;
                subtitleEl.textContent = p.subtitle;
                msgEl.textContent = p.message;
                pillTextEl.textContent = p.pill;
                idEl.textContent = id;

                confirmBtn.className = "btn " + p.btnClass;
                confirmBtn.textContent = p.btnText;

                modal.classList.add("sa-open");
                modal.setAttribute("aria-hidden", "false");

                setTimeout(() => confirmBtn.focus(), 0);
                if (window.feather) window.feather.replace();
            }

            function closeModal() {
                if (!modal) return;
                modal.classList.remove("sa-open");
                modal.setAttribute("aria-hidden", "true");
                currentFormId = null;
            }

            qaCancel?.addEventListener("click", function () {
                if (qaCancel.disabled) return;
                openModal("cancel", "@Model.Id");
            });

            qaNoShow?.addEventListener("click", function () {
                if (qaNoShow.disabled) return;
                openModal("noshow", "@Model.Id");
            });

            modal?.querySelectorAll("[data-sa-close]").forEach(x => {
                x.addEventListener("click", closeModal);
            });

            confirmBtn?.addEventListener("click", function () {
                if (!currentFormId) return;
                const form = document.getElementById(currentFormId);
                if (form) form.submit();
            });

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape" && modal?.classList.contains("sa-open")) closeModal();
            });

            ["input", "change"].forEach(evt => {
                customerName?.addEventListener(evt, refreshSummary);
                customerEmail?.addEventListener(evt, refreshSummary);

                statusSelect?.addEventListener(evt, refreshSummary);

                svcSelect?.addEventListener(evt, function () { refreshSummary(); loadSlots(); });
                dateInput?.addEventListener(evt, function () { refreshSummary(); loadSlots(); });

                startTimeInput?.addEventListener(evt, refreshSummary);
                durInput?.addEventListener(evt, refreshSummary);
                priceInput?.addEventListener(evt, refreshSummary);
            });

            refreshSummary();
            loadSlots();

            if (window.feather) window.feather.replace();
        })();
    </script>
}