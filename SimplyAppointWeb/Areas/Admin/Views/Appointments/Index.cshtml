@using SimplyAppoint.Models.Enums
@using SimplyAppoint.Models.ViewModels
@model AppointmentsIndexVM
@{
    ViewData["Title"] = "Appointments";
    Layout = "_AdminLayout";

    string StatusBadgeClass(AppointmentStatus s)
    {
        return s switch
        {
            AppointmentStatus.Confirmed => "badge-success-light",
            AppointmentStatus.Pending => "badge-warning-light",
            AppointmentStatus.Cancelled => "badge-danger-light",
            AppointmentStatus.NoShow => "badge-dark-light",
            AppointmentStatus.Completed => "badge-info-light",
            _ => "badge-primary-light"
        };
    }

    string StatusLabel(AppointmentStatus s) => s switch
    {
        AppointmentStatus.NoShow => "No show",
        _ => s.ToString()
    };

    var qVal = Model?.Query ?? "";
    var rangeVal = Model?.DateRange ?? "week";
    var statusVal = Model?.Status ?? "all";
}

<style>
    .list-group-item {
        background: transparent !important;
        color: rgba(255,255,255,.92) !important;
        border-color: rgba(255,255,255,.10) !important;
    }

    .list-group-item:hover {
        background: rgba(255,255,255,.04) !important;
    }

    .list-group-item .text-muted {
        color: rgba(255,255,255,.60) !important;
    }

    .dropdown-menu {
        background: #222e3c;
        border: 1px solid rgba(255,255,255,.10);
    }

    .dropdown-menu .text-muted {
        color: rgba(255,255,255,.60) !important;
    }

    .dropdown-menu .form-select,
    .dropdown-menu .form-control {
        background-color: rgba(255,255,255,.06);
        color: rgba(255,255,255,.92);
        border-color: rgba(255,255,255,.10);
    }

    .dropdown-menu .form-select option {
        background: #222e3c;
        color: rgba(255,255,255,.92);
    }

    .input-group-navbar .form-control {
        min-width: 220px;
    }

    .sa-actions .btn {
        padding: .28rem .55rem;
        line-height: 1.2;
    }

    .sa-actions .btn + .btn,
    .sa-actions form + form,
    .sa-actions a + form,
    .sa-actions form + a {
        margin-left: .35rem;
    }

    .sa-iconbtn {
        width: 36px;
        height: 34px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
    }

    .sa-iconbtn i {
        width: 16px;
        height: 16px;
    }

    .btn-outline-danger.sa-iconbtn {
        border-color: rgba(220,53,69,.55);
    }

    .btn-outline-danger.sa-iconbtn:hover {
        background: rgba(220,53,69,.12);
    }

    .btn-outline-warning.sa-iconbtn {
        border-color: rgba(255,193,7,.55);
        color: rgba(255,255,255,.85);
    }

    .btn-outline-warning.sa-iconbtn:hover {
        background: rgba(255,193,7,.12);
    }

    .btn-outline-secondary.sa-iconbtn {
        border-color: rgba(173,181,189,.45);
        color: rgba(255,255,255,.82);
    }

    .btn-outline-secondary.sa-iconbtn:hover {
        background: rgba(173,181,189,.10);
    }

    .sa-actions button:disabled {
        opacity: .35;
        cursor: not-allowed;
    }

    .sa-modal {
        position: fixed;
        inset: 0;
        z-index: 1055;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .sa-modal.sa-open {
        display: flex;
    }

    .sa-modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(4px);
    }

    .sa-modal-card {
        position: relative;
        width: 100%;
        max-width: 520px;
        background: #222e3c;
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 18px;
        box-shadow: 0 18px 55px rgba(0,0,0,.55);
        overflow: hidden;
        transform: translateY(6px);
        animation: saPop .14s ease-out forwards;
    }

    @@keyframes saPop {
        to {
            transform: translateY(0);
        }
    }

    .sa-modal-head {
        padding: 18px 20px;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        border-bottom: 1px solid rgba(255,255,255,.08);
    }

    .sa-modal-title {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 800;
        color: rgba(255,255,255,.92);
    }

    .sa-modal-close {
        background: transparent;
        border: 0;
        color: rgba(255,255,255,.75);
        width: 38px;
        height: 38px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .sa-modal-close:hover {
        background: rgba(255,255,255,.06);
    }

    .sa-modal-body {
        padding: 18px 20px 6px 20px;
        color: rgba(255,255,255,.86);
    }

    .sa-modal-body .text-muted {
        color: rgba(255,255,255,.60) !important;
    }

    .sa-modal-foot {
        padding: 14px 20px 18px 20px;
        display: flex;
        justify-content: flex-end;
        gap: .5rem;
        border-top: 1px solid rgba(255,255,255,.08);
        background: rgba(255,255,255,.02);
    }

    .sa-pill {
        display: inline-flex;
        align-items: center;
        gap: .35rem;
        padding: .35rem .6rem;
        border-radius: 999px;
        font-weight: 700;
        font-size: .78rem;
        border: 1px solid rgba(255,255,255,.10);
        color: rgba(255,255,255,.86);
        background: rgba(255,255,255,.04);
        white-space: nowrap;
    }

    .sa-hintbox {
        margin-top: 12px;
        padding: 12px 12px;
        border-radius: 14px;
        border: 1px dashed rgba(255,255,255,.14);
        background: rgba(255,255,255,.03);
        color: rgba(255,255,255,.78);
        font-size: .9rem;
    }
</style>

<div class="row mb-2 mb-xl-3 align-items-center">
    <div class="col-auto d-none d-sm-block">
        <h3 class="mb-0"><strong>Appointments</strong></h3>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="calendar"></i> Calendar
        </a>
        <a asp-area="Admin" asp-controller="Appointments" asp-action="Create" class="btn btn-primary">
            <i class="align-middle me-1" data-feather="plus"></i> New Appointment
        </a>
    </div>
</div>

<!-- Stats row -->
<div class="row">
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Today</h5></div>
                    <div class="col-auto">
                        <div class="stat text-primary"><i class="align-middle" data-feather="clock"></i></div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.TodayCount</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">live</span>
                    <span class="text-muted">appointments today</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Next 7 Days</h5></div>
                    <div class="col-auto">
                        <div class="stat text-primary"><i class="align-middle" data-feather="calendar"></i></div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.Next7DaysCount</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">live</span>
                    <span class="text-muted">upcoming bookings</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Revenue (Week)</h5></div>
                    <div class="col-auto">
                        <div class="stat text-primary"><i class="align-middle" data-feather="credit-card"></i></div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">€ @Model.RevenueWeek.ToString("0.00")</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">earned</span>
                    <span class="text-muted">completed + ended</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0"><h5 class="card-title">Cancellations</h5></div>
                    <div class="col-auto">
                        <div class="stat text-primary"><i class="align-middle" data-feather="x-circle"></i></div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.CancellationsWeek</h1>
                <div class="mb-0">
                    <span class="badge badge-danger-light">attention</span>
                    <span class="text-muted">cancelled this week</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main table -->
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                        <h5 class="card-title mb-0">Appointments</h5>
                        <div class="text-muted">Filter and manage your schedule</div>
                    </div>

                    <!-- Search + Filters -->
                    <form method="get"
                          asp-area="Admin"
                          asp-controller="Appointments"
                          asp-action="Index"
                          class="d-flex gap-2 align-items-center flex-wrap">

                        <div class="input-group input-group-navbar">
                            <input type="text"
                                   class="form-control"
                                   name="q"
                                   value="@qVal"
                                   placeholder="Search…"
                                   aria-label="Search">
                            <button class="btn" type="submit" aria-label="Search">
                                <i class="align-middle" data-feather="search"></i>
                            </button>
                        </div>

                        <div class="dropdown">
                            <button class="btn btn-light bg-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="align-middle me-1" data-feather="filter"></i> Filters
                            </button>

                            <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
                                <div class="mb-2 text-muted fw-semibold">Date range</div>
                                <select class="form-select mb-3" name="range" onchange="this.form.submit()">
                                    <option value="today" selected="@(rangeVal == "today")">Today</option>
                                    <option value="week" selected="@(rangeVal == "week")">This week</option>
                                    <option value="month" selected="@(rangeVal == "month")">This month</option>
                                    <option value="all" selected="@(rangeVal == "all")">All</option>
                                </select>

                                <div class="mb-2 text-muted fw-semibold">Status</div>
                                <select class="form-select" name="status" onchange="this.form.submit()">
                                    <option value="all" selected="@(statusVal == "all")">All</option>
                                    <option value="Confirmed" selected="@(statusVal == "Confirmed")">Confirmed</option>
                                    <option value="Pending" selected="@(statusVal == "Pending")">Pending</option>
                                    <option value="Cancelled" selected="@(statusVal == "Cancelled")">Cancelled</option>
                                    <option value="NoShow" selected="@(statusVal == "NoShow")">No show</option>
                                    <option value="Completed" selected="@(statusVal == "Completed")">Completed</option>
                                </select>

                                <input type="hidden" name="q" value="@qVal" />
                            </div>
                        </div>

                        <a asp-area="Admin"
                           asp-controller="Appointments"
                           asp-action="Index"
                           class="btn btn-outline-light">
                            <i class="align-middle me-1" data-feather="rotate-ccw"></i> Reset
                        </a>
                    </form>
                </div>
            </div>

            <div class="card-body pt-0">
                <div class="table-responsive">
                    <table class="table table-hover my-0">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Customer</th>
                                <th class="d-none d-xl-table-cell">Service</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Rows != null && Model.Rows.Any())
                            {
                                foreach (var row in Model.Rows)
                                {
                                    var isLocked = row.Status == AppointmentStatus.Cancelled
                                    || row.Status == AppointmentStatus.Completed
                                    || row.Status == AppointmentStatus.NoShow;

                                    var canMarkNoShow = row.Status == AppointmentStatus.Completed;

                                    var canCancel = !isLocked && row.Status != AppointmentStatus.Cancelled;
                                    var canHardDelete = !isLocked; 

                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@row.WhenTime</div>
                                            <div class="text-muted small">@row.WhenDate</div>
                                        </td>
                                        <td>
                                            <div class="fw-semibold">@row.CustomerDisplay</div>
                                            @if (!string.IsNullOrWhiteSpace(row.CustomerSub))
                                            {
                                                <div class="text-muted small">@row.CustomerSub</div>
                                            }
                                        </td>
                                        <td class="d-none d-xl-table-cell">
                                            <div class="fw-semibold">@row.ServiceName</div>
                                        </td>
                                        <td>
                                            <span class="badge @StatusBadgeClass(row.Status)">@StatusLabel(row.Status)</span>
                                        </td>
                                        <td class="text-end sa-actions">
                                            <a asp-area="Admin"
                                               asp-controller="Appointments"
                                               asp-action="Edit"
                                               asp-route-id="@row.Id"
                                               class="btn btn-primary btn-sm"
                                               title="Open">
                                                Open
                                            </a>

                                            <button type="button"
                                                    class="btn btn-outline-warning btn-sm sa-iconbtn"
                                                    title="@(canMarkNoShow ? "Mark No show" : "You can only mark No show after the appointment ended")"
                                                    @(canMarkNoShow ? "" : "disabled")
                                                    data-sa-open-modal="noshow"
                                                    data-sa-id="@row.Id">
                                                <i class="align-middle" data-feather="user-x"></i>
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-danger btn-sm sa-iconbtn"
                                                    title="Cancel"
                                                    @(canCancel ? "" : "disabled")
                                                    data-sa-open-modal="cancel"
                                                    data-sa-id="@row.Id">
                                                <i class="align-middle" data-feather="x"></i>
                                            </button>

                                            <button type="button"
                                                    class="btn btn-outline-secondary btn-sm sa-iconbtn"
                                                    title="Hard delete"
                                                    @(canHardDelete ? "" : "disabled")
                                                    data-sa-open-modal="delete"
                                                    data-sa-id="@row.Id">
                                                <i class="align-middle" data-feather="trash-2"></i>
                                            </button>

                                            <form id="saNoshowForm-@row.Id"
                                                  class="d-none"
                                                  method="post"
                                                  asp-area="Admin"
                                                  asp-controller="Appointments"
                                                  asp-action="MarkNoShow"
                                                  asp-route-id="@row.Id">
                                                @Html.AntiForgeryToken()
                                            </form>

                                            <form id="saCancelForm-@row.Id"
                                                  class="d-none"
                                                  method="post"
                                                  asp-area="Admin"
                                                  asp-controller="Appointments"
                                                  asp-action="Cancel"
                                                  asp-route-id="@row.Id">
                                                @Html.AntiForgeryToken()
                                            </form>

                                            <form id="saDeleteForm-@row.Id"
                                                  class="d-none"
                                                  method="post"
                                                  asp-area="Admin"
                                                  asp-controller="Appointments"
                                                  asp-action="DeleteHard"
                                                  asp-route-id="@row.Id">
                                                @Html.AntiForgeryToken()
                                            </form>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        No appointments found for the selected filters.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="text-muted mt-3">Showing @Model.TotalShown appointment(s)</div>
            </div>
        </div>
    </div>

    <!-- Right side column -->
    <div class="col-12 col-lg-4 d-flex">
        <div class="d-flex flex-column w-100">

            <!-- Today Overview -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Today Overview</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Date</span>
                        <span class="fw-semibold">@DateTime.Today.ToString("ddd, dd MMM")</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Appointments</span>
                        <span class="badge badge-primary-light">@Model.TodayCount</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Open slots</span>
                        <span class="badge badge-success-light">@Model.OpenSlotsCount</span>
                    </div>
                    <div class="d-grid">
                        <a asp-area="Admin" asp-controller="Appointments" asp-action="Create" class="btn btn-primary">
                            <i class="align-middle me-2" data-feather="plus"></i> Book Appointment
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upcoming (Next 3)</h5>
                </div>
                <div class="card-body pt-2">
                    <div class="list-group">
                        @if (Model.Upcoming != null && Model.Upcoming.Any())
                        {
                            foreach (var u in Model.Upcoming.Take(3))
                            {
                                <a asp-area="Admin"
                                   asp-controller="Appointments"
                                   asp-action="Edit"
                                   asp-route-id="@u.Id"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between">
                                        <strong>@u.Time</strong>
                                        <span class="badge @StatusBadgeClass(u.Status)">@StatusLabel(u.Status)</span>
                                    </div>
                                    <div class="text-muted">@u.Customer - @u.Service</div>
                                </a>
                            }
                        }
                        else
                        {
                            <div class="text-center py-3 text-muted">No upcoming appointments.</div>
                        }
                    </div>

                    <div class="d-grid mt-3">
                        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white">
                            Open calendar
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body pt-2">
                    <div class="row g-2">
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Customers" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="users"></i>
                                <span class="fw-semibold">Customers</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Services" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="briefcase"></i>
                                <span class="fw-semibold">Services</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="bar-chart-2"></i>
                                <span class="fw-semibold">Dashboard</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Settings" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="settings"></i>
                                <span class="fw-semibold">Settings</span>
                            </a>
                        </div>
                    </div>
                    <div class="sa-hintbox mt-3">
                        Tip: Cancelled and Completed appointments are locked. Use <strong>Open</strong> to view details.
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Reusable centered modal -->
<div class="sa-modal" id="saModal" aria-hidden="true">
    <div class="sa-modal-backdrop" data-sa-close></div>

    <div class="sa-modal-card" role="dialog" aria-modal="true" aria-labelledby="saModalTitle">
        <div class="sa-modal-head">
            <div>
                <h5 class="sa-modal-title" id="saModalTitle">Confirm</h5>
                <div class="text-muted small" id="saModalSubtitle">—</div>
            </div>
            <button type="button" class="sa-modal-close" data-sa-close aria-label="Close">
                <i data-feather="x"></i>
            </button>
        </div>

        <div class="sa-modal-body">
            <div id="saModalMessage" class="mb-2">—</div>

            <div class="d-flex flex-wrap gap-2 mt-3">
                <span class="sa-pill" id="saModalPill">
                    <i data-feather="alert-triangle"></i>
                    <span id="saModalPillText">Action</span>
                </span>
                <span class="sa-pill">
                    <i data-feather="hash"></i>
                    <span>Appointment ID:</span>
                    <span class="fw-bold" id="saModalId">—</span>
                </span>
            </div>
        </div>

        <div class="sa-modal-foot">
            <button type="button" class="btn btn-outline-light" data-sa-close>Cancel</button>
            <button type="button" class="btn btn-danger" id="saModalConfirmBtn">
                Confirm
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const modal = document.getElementById("saModal");
            const titleEl = document.getElementById("saModalTitle");
            const subtitleEl = document.getElementById("saModalSubtitle");
            const msgEl = document.getElementById("saModalMessage");
            const pillTextEl = document.getElementById("saModalPillText");
            const idEl = document.getElementById("saModalId");
            const confirmBtn = document.getElementById("saModalConfirmBtn");

            let currentFormId = null;

            const presets = {
                cancel: {
                    title: "Cancel appointment?",
                    subtitle: "This will permanently cancel the booking.",
                    message: "The customer will be notified by email (if an email exists). You can’t reopen a cancelled appointment.",
                    pill: "Cancel",
                    btnClass: "btn-danger",
                    btnText: "Yes, cancel"
                },
                delete: {
                    title: "Hard delete appointment?",
                    subtitle: "This will remove the appointment permanently.",
                    message: "Hard delete cannot be undone. Use only for test bookings or mistakes.",
                    pill: "Hard delete",
                    btnClass: "btn-danger",
                    btnText: "Yes, delete"
                },
                noshow: {
                    title: "Mark as No show?",
                    subtitle: "Only do this if the customer did not come.",
                    message: "No show appointments are excluded from revenue. You can still open the appointment afterwards.",
                    pill: "No show",
                    btnClass: "btn-warning",
                    btnText: "Yes, mark No show"
                }
            };

            function openModal(kind, id) {
                const p = presets[kind];
                if (!p) return;

                currentFormId = (kind === "cancel")
                    ? `saCancelForm-${id}`
                    : (kind === "delete")
                        ? `saDeleteForm-${id}`
                        : `saNoshowForm-${id}`;

                titleEl.textContent = p.title;
                subtitleEl.textContent = p.subtitle;
                msgEl.textContent = p.message;
                pillTextEl.textContent = p.pill;
                idEl.textContent = id;

                confirmBtn.className = "btn " + p.btnClass;
                confirmBtn.textContent = p.btnText;

                modal.classList.add("sa-open");
                modal.setAttribute("aria-hidden", "false");

                setTimeout(() => confirmBtn.focus(), 0);
                if (window.feather) window.feather.replace();
            }

            function closeModal() {
                modal.classList.remove("sa-open");
                modal.setAttribute("aria-hidden", "true");
                currentFormId = null;
            }

            document.querySelectorAll("[data-sa-open-modal]").forEach(btn => {
                btn.addEventListener("click", function () {
                    if (btn.hasAttribute("disabled")) return;
                    const kind = btn.getAttribute("data-sa-open-modal");
                    const id = btn.getAttribute("data-sa-id");
                    openModal(kind, id);
                });
            });

            modal.querySelectorAll("[data-sa-close]").forEach(x => {
                x.addEventListener("click", closeModal);
            });

            confirmBtn.addEventListener("click", function () {
                if (!currentFormId) return;
                const form = document.getElementById(currentFormId);
                if (form) form.submit();
            });

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape" && modal.classList.contains("sa-open")) {
                    closeModal();
                }
            });

            if (window.feather) window.feather.replace();
        })();
    </script>
}