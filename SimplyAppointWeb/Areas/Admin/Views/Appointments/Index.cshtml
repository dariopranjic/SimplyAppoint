@using SimplyAppoint.Models.Enums
@using SimplyAppoint.Models.ViewModels
@model AppointmentsIndexVM
@{
    ViewData["Title"] = "Appointments";
    Layout = "_AdminLayout";

    string StatusBadgeClass(AppointmentStatus s)
    {
        return s switch
        {
            AppointmentStatus.Confirmed => "badge-success-light",
            AppointmentStatus.Pending => "badge-warning-light",
            AppointmentStatus.Cancelled => "badge-danger-light",
            _ => "badge-primary-light"
        };
    }

    string StatusLabel(AppointmentStatus s) => s.ToString();
}

<style>
    .list-group-item {
        background: transparent !important;
        color: rgba(255,255,255,.92) !important;
        border-color: rgba(255,255,255,.10) !important;
    }

        .list-group-item:hover {
            background: rgba(255,255,255,.04) !important;
        }

        .list-group-item .text-muted {
            color: rgba(255,255,255,.60) !important;
        }

    .dropdown-menu {
        background: #222e3c;
        border: 1px solid rgba(255,255,255,.10);
    }

        .dropdown-menu .text-muted {
            color: rgba(255,255,255,.60) !important;
        }

        .dropdown-menu .form-select,
        .dropdown-menu .form-control {
            background-color: rgba(255,255,255,.06);
            color: rgba(255,255,255,.92);
            border-color: rgba(255,255,255,.10);
        }

            .dropdown-menu .form-select option {
                background: #222e3c;
                color: rgba(255,255,255,.92);
            }

    .input-group-navbar .form-control {
        min-width: 220px;
    }
</style>

<div class="row mb-2 mb-xl-3 align-items-center">
    <div class="col-auto d-none d-sm-block">
        <h3 class="mb-0"><strong>Appointments</strong></h3>
    </div>

    <div class="col-auto ms-auto text-end mt-n1">
        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white me-2">
            <i class="align-middle me-1" data-feather="calendar"></i> Calendar
        </a>
        <a asp-area="Admin" asp-controller="Appointments" asp-action="Create" class="btn btn-primary">
            <i class="align-middle me-1" data-feather="plus"></i> New Appointment
        </a>
    </div>
</div>

<!-- Stats row -->
<div class="row">
    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0">
                        <h5 class="card-title">Today</h5>
                    </div>
                    <div class="col-auto">
                        <div class="stat text-primary">
                            <i class="align-middle" data-feather="clock"></i>
                        </div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.TodayCount</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">live</span>
                    <span class="text-muted">appointments today</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0">
                        <h5 class="card-title">Next 7 Days</h5>
                    </div>
                    <div class="col-auto">
                        <div class="stat text-primary">
                            <i class="align-middle" data-feather="calendar"></i>
                        </div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.Next7DaysCount</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">live</span>
                    <span class="text-muted">upcoming bookings</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0">
                        <h5 class="card-title">Revenue (Week)</h5>
                    </div>
                    <div class="col-auto">
                        <div class="stat text-primary">
                            <i class="align-middle" data-feather="credit-card"></i>
                        </div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">€ @Model.RevenueWeek.ToString("0.00")</h1>
                <div class="mb-0">
                    <span class="badge badge-primary-light">est.</span>
                    <span class="text-muted">confirmed bookings</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-sm-6 col-xl-3">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col mt-0">
                        <h5 class="card-title">Cancellations</h5>
                    </div>
                    <div class="col-auto">
                        <div class="stat text-primary">
                            <i class="align-middle" data-feather="x-circle"></i>
                        </div>
                    </div>
                </div>
                <h1 class="mt-1 mb-3">@Model.CancellationsWeek</h1>
                <div class="mb-0">
                    <span class="badge badge-danger-light">attention</span>
                    <span class="text-muted">cancelled bookings</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main table -->
    <div class="col-12 col-lg-8 d-flex">
        <div class="card flex-fill">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <div>
                        <h5 class="card-title mb-0">Appointments</h5>
                        <div class="text-muted">Filter and manage your schedule</div>
                    </div>

                    <!-- Search + Filters -->
                    <form method="get"
                          asp-area="Admin"
                          asp-controller="Appointments"
                          asp-action="Index"
                          class="d-flex gap-2 align-items-center flex-wrap">

                        <div class="input-group input-group-navbar">
                            <input type="text"
                                   class="form-control"
                                   name="q"
                                   value="@Model.Query"
                                   placeholder="Search…"
                                   aria-label="Search">
                            <button class="btn" type="submit" aria-label="Search">
                                <i class="align-middle" data-feather="search"></i>
                            </button>
                        </div>

                        <div class="dropdown">
                            <button class="btn btn-light bg-white dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="align-middle me-1" data-feather="filter"></i> Filters
                            </button>

                            <div class="dropdown-menu dropdown-menu-end p-3" style="min-width: 320px;">
                                <div class="mb-2 text-muted fw-semibold">Date range</div>
                                <select class="form-select mb-3" name="range" onchange="this.form.submit()">
                                    <option value="today" selected="@(Model.DateRange == "today")">Today</option>
                                    <option value="week" selected="@(Model.DateRange == "week")">This week</option>
                                    <option value="month" selected="@(Model.DateRange == "month")">This month</option>
                                    <option value="all" selected="@(Model.DateRange == "all")">All</option>
                                </select>

                                <div class="mb-2 text-muted fw-semibold">Status</div>
                                <select class="form-select" name="status" onchange="this.form.submit()">
                                    <option value="all" selected="@(Model.Status == "all")">All</option>
                                    <option value="Confirmed" selected="@(Model.Status == "Confirmed")">Confirmed</option>
                                    <option value="Pending" selected="@(Model.Status == "Pending")">Pending</option>
                                    <option value="Cancelled" selected="@(Model.Status == "Cancelled")">Cancelled</option>
                                </select>

                                <input type="hidden" name="q" value="@Model.Query" />
                            </div>
                        </div>

                        <a asp-area="Admin"
                           asp-controller="Appointments"
                           asp-action="Index"
                           class="btn btn-outline-light">
                            <i class="align-middle me-1" data-feather="rotate-ccw"></i> Reset
                        </a>
                    </form>
                </div>
            </div>

            <div class="card-body pt-0">
                <div class="table-responsive">
                    <table class="table table-hover my-0">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Customer</th>
                                <th class="d-none d-xl-table-cell">Service</th>
                                <th>Status</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Rows != null && Model.Rows.Any())
                            {
                                foreach (var row in Model.Rows)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-semibold">@row.WhenTime</div>
                                            <div class="text-muted small">@row.WhenDate</div>
                                        </td>
                                        <td>
                                            <div class="fw-semibold">@row.CustomerDisplay</div>
                                            @if (!string.IsNullOrWhiteSpace(row.CustomerSub))
                                            {
                                                <div class="text-muted small">@row.CustomerSub</div>
                                            }
                                        </td>
                                        <td class="d-none d-xl-table-cell">
                                            <div class="fw-semibold">@row.ServiceName</div>
                                        </td>
                                        <td>
                                            <span class="badge @StatusBadgeClass(row.Status)">@StatusLabel(row.Status)</span>
                                        </td>
                                        <td class="text-end">
                                            <a asp-area="Admin"
                                               asp-controller="Appointments"
                                               asp-action="Edit"
                                               asp-route-id="@row.Id"
                                               class="btn btn-primary btn-sm">
                                                Open
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        No appointments found for the selected filters.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="text-muted mt-3">Showing @Model.TotalShown appointment(s)</div>
            </div>
        </div>
    </div>

    <!-- Right side column -->
    <div class="col-12 col-lg-4 d-flex">
        <div class="d-flex flex-column w-100">

            <!-- Today Overview -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Today Overview</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Date</span>
                        <span class="fw-semibold">@DateTime.Today.ToString("ddd, dd MMM")</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Appointments</span>
                        <span class="badge badge-primary-light">@Model.TodayCount</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Open slots</span>
                        <span class="badge badge-success-light">@Model.OpenSlotsCount</span>
                    </div>
                    <div class="d-grid">
                        <a asp-area="Admin" asp-controller="Appointments" asp-action="Create" class="btn btn-primary">
                            <i class="align-middle me-2" data-feather="plus"></i> Book Appointment
                        </a>
                    </div>
                </div>
            </div>

            <!-- Upcoming -->
            <div class="card flex-fill mb-3">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upcoming (Next 3)</h5>
                </div>
                <div class="card-body pt-2">
                    <div class="list-group">
                        @if (Model.Upcoming != null && Model.Upcoming.Any())
                        {
                            foreach (var u in Model.Upcoming.Take(3))
                            {
                                <a asp-area="Admin"
                                   asp-controller="Appointments"
                                   asp-action="Edit"
                                   asp-route-id="@u.Id"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between">
                                        <strong>@u.Time</strong>
                                        <span class="badge @StatusBadgeClass(u.Status)">@StatusLabel(u.Status)</span>
                                    </div>
                                    <div class="text-muted">@u.Customer - @u.Service</div>
                                </a>
                            }
                        }
                        else
                        {
                            <div class="text-center py-3 text-muted">No upcoming appointments.</div>
                        }
                    </div>

                    <div class="d-grid mt-3">
                        <a asp-area="Admin" asp-controller="Calendar" asp-action="Index" class="btn btn-light bg-white">
                            Open calendar
                        </a>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body pt-2">
                    <div class="row g-2">
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Customers" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="users"></i>
                                <span class="fw-semibold">Customers</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Services" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="briefcase"></i>
                                <span class="fw-semibold">Services</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="bar-chart-2"></i>
                                <span class="fw-semibold">Dashboard</span>
                            </a>
                        </div>
                        <div class="col-6">
                            <a asp-area="Admin" asp-controller="Settings" asp-action="Index"
                               class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2">
                                <i class="align-middle me-2" data-feather="settings"></i>
                                <span class="fw-semibold">Settings</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>